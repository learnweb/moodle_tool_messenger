{"version":3,"sources":["../src/options.js"],"names":["define","$","modalfactory","url","ajax","append","formid","name","value","attr","appendTo","show_message","event","preventDefault","button","currentTarget","id","getAttribute","type","call","methodname","args","done","response","data","JSON","parse","create","types","ALERT","title","subject","body","message","then","modal","show","fail","ex","window","console","log","initialize_showmessage_buttons","each","i","x","on","init_select_all_button","click","vals","children","option","push","val","init_predicitonlink","parent","params","length","roles","unix","prop","day","month","year","Math","floor","Date","getTime","firstlogin","fday","fmonth","fyear","Number","MAX_SAFE_INTEGER","join","text","sanitize_form","remove","input","split","init","document","ready"],"mappings":"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","sourcesContent":["define(['jquery', 'core/modal_factory', 'core/url', 'core/ajax'], function ($, modalfactory, url, ajax) {\n\n    /**\n     * Returns a function that will append a supplied form with a key: value pair\n     * @param formid the forms id\n     * @param name the key name\n     * @param value the value\n     * @returns {(function(): void)}\n     */\n    var append = function(formid, name, value) {\n        return function() {\n            $(\"<input />\").attr(\"type\", \"hidden\")\n                .attr(\"name\", name)\n                .attr(\"value\", value)\n                .appendTo(\"#\" + formid);\n        };\n    };\n\n    /**\n     * Shows the message that was sent with a tool_messenge instance.\n     * the message id has to be supplied by the events current target through its messageid attribute.\n     * @param event\n     */\n    var show_message = function (event) {\n        event.preventDefault();\n        var button = event.currentTarget;\n        var id = button.getAttribute(\"messageid\");\n        var type = button.getAttribute('type');\n        ajax.call([\n            {methodname: 'tool_messenger_get_message', args: {'id': id, 'type': type}}\n        ])[0].done(function (response) {\n            var data = JSON.parse(response);\n            modalfactory.create({\n                type: modalfactory.types.ALERT,\n                title: data.subject,\n                body: data.message\n            }).then(function (modal) {\n                modal.show();\n            });\n        }).fail(function (ex) {\n            window.console.log('fetch message failed: ');\n            window.console.log(ex);\n        });\n    };\n\n    var initialize_showmessage_buttons = function () {\n        $('button.showmessagebutton').each(function(i, x) {\n            $(x).on('click', show_message);\n            return true; // Makes this a foreach loop.\n        });\n    };\n\n    var init_select_all_button = function () {\n        $('#id_select_all_recipients').click(function () {\n            var vals = [];\n            $('#id_recipients').children().each(\n                function (i, option) {\n                    vals.push(option.value);\n                }\n            );\n            $('#id_recipients').val(vals);\n        });\n    };\n\n    var init_predicitonlink = function () {\n\n        $('#predictiontrigger').click(function (event) {\n            event.preventDefault();\n            var parent = $('#id_followup');\n            var params;\n            if (parent.length > 0) {\n                params = {'parentid': parent.val()};\n            } else {\n                // Get roles.\n                var roles = [];\n                $('#id_recipients').children(':selected').each(function (i, x) {\n                    roles.push(x.value);\n                });\n                // Get time.\n                var unix;\n                if ($('#id_knockout_enable').prop('checked')) {\n                    var day = $('#id_knockout_date_day').val();\n                    var month = $('#id_knockout_date_month').val();\n                    var year = $('#id_knockout_date_year').val();\n                    unix = Math.floor(new Date(year + \".\" + month + \".\" + day).getTime() / 1000);\n                } else {\n                    unix = -1;\n                }\n                var firstlogin;\n                if ($('#id_firstlogindateenable').prop('checked')) {\n                    var fday = $('#id_knockout_date_day').val();\n                    var fmonth = $('#id_knockout_date_month').val();\n                    var fyear = $('#id_knockout_date_year').val();\n                    firstlogin = Math.floor(new Date(fyear + \".\" + fmonth + \".\" + fday).getTime() / 1000);\n                } else {\n                    firstlogin = Number.MAX_SAFE_INTEGER;\n                }\n                // Build url.\n                params = {'roles': roles.join(\",\"), 'knockoutdate': unix, 'firstlogindate': firstlogin};\n            }\n            ajax.call([\n                {methodname: 'tool_messenger_predict_users', args: params}\n            ])[0].done(function (response) {\n                $('#predictionbox').text(response);\n            }).fail(function (ex) {\n                window.console.log('fetch predicted users failed: ');\n                window.console.log(ex);\n                window.console.log(ex.message);\n            });\n        });\n    };\n\n    /**\n     * This function removes all hidden followup and abort fields and attaches a listener to the abort\n     * and followup buttons that will add them as followup:id or abort:id in the form on click.\n     * This is done to enable the use of the abort and followup button while using mform->data which would be sanitized\n     * otherwise. It also ensures that \"abort\" or \"followup\" will not be saved across instances of this form as to stop\n     * accidental resending of this formdata.\n     */\n    var sanitize_form = function () {\n        $('input[name=abort][type=hidden]').each(function (i, x) {\n            x.remove();\n        });\n        $('input[name=abortpopup][type=hidden]').each(function (i, x) {\n            x.remove();\n        });\n        $('input[name=followup][type=hidden]').each(function (i, x) {\n            x.remove();\n        });\n        $('td > input').each(function (i, input) {\n            var button = $(input);\n            var [name, value] = input[\"id\"].split('_');\n            button.on('click', append($('form.mform')[0].id, name, value));\n            return true;\n        });\n    };\n\n    var init = function() {\n        $(document).ready(function() {\n            sanitize_form();\n            initialize_showmessage_buttons();\n            init_predicitonlink();\n            init_select_all_button();\n        });\n    };\n\n    return {\n        init: init\n    };\n});"],"file":"options.min.js"}