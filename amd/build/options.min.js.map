{"version":3,"sources":["../src/options.js"],"names":["define","$","modalfactory","url","ajax","append","formid","name","value","attr","appendTo","show_message","event","preventDefault","button","currentTarget","id","getAttribute","call","methodname","args","done","response","data","JSON","parse","create","type","types","ALERT","title","subject","body","message","then","modal","show","fail","ex","window","console","log","initialize_showmessage_buttons","each","i","x","on","init_predicitonlink","click","parent","params","length","val","roles","children","push","unix","prop","day","month","year","Math","floor","Date","getTime","join","text","sanitize_form","remove","input","split","init","document","ready"],"mappings":"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","sourcesContent":["define(['jquery', 'core/modal_factory', 'core/url', 'core/ajax'], function ($, modalfactory, url, ajax) {\n\n    /**\n     * Returns a function that will append a supplied form with a key: value pair\n     * @param formid the forms id\n     * @param name the key name\n     * @param value the value\n     * @returns {(function(): void)}\n     */\n    var append = function(formid, name, value) {\n        return function() {\n            $(\"<input />\").attr(\"type\", \"hidden\")\n                .attr(\"name\", name)\n                .attr(\"value\", value)\n                .appendTo(\"#\" + formid);\n        };\n    };\n\n    /**\n     * Shows the message that was sent with a tool_messenge instance.\n     * the message id has to be supplied by the events current target through its messageid attribute.\n     * @param event\n     */\n    var show_message = function (event) {\n        event.preventDefault();\n        var button = event.currentTarget;\n        var id = button.getAttribute(\"messageid\");\n        ajax.call([\n            {methodname: 'tool_messenger_get_message', args: {'id': id}}\n        ])[0].done(function (response) {\n            var data = JSON.parse(response);\n            modalfactory.create({\n                type: modalfactory.types.ALERT,\n                title: data.subject,\n                body: data.message\n            }).then(function (modal) {\n                modal.show();\n            });\n        }).fail(function (ex) {\n            window.console.log('fetch message failed: ');\n            window.console.log(ex);\n        });\n    };\n\n    var initialize_showmessage_buttons = function () {\n        $('button.showmessagebutton').each(function(i, x) {\n            $(x).on('click', show_message);\n            return true; // Makes this a foreach loop.\n        });\n    };\n\n    var init_predicitonlink = function () {\n\n        $('#predictiontrigger').click(function (event) {\n            event.preventDefault();\n            var parent = $('#id_followup');\n            var params;\n            if (parent.length > 0) {\n                params = {'parentid': parent.val()};\n            } else {\n                // Get roles.\n                var roles = [];\n                $('#id_recipients').children(':selected').each(function (i, x) {\n                    roles.push(x.value);\n                });\n                // Get time.\n                var unix;\n                if ($('#id_knockout_enable').prop('checked')) {\n                    var day = $('#id_knockout_date_day').val();\n                    var month = $('#id_knockout_date_month').val();\n                    var year = $('#id_knockout_date_year').val();\n                    unix = Math.floor(new Date(year + \"-\" + month + \"-\" + day).getTime() / 1000);\n                } else {\n                    unix = -1;\n                }\n                // Build url.\n                params = {'roles': roles.join(\",\"), 'knockoutdate': unix};\n            }\n            ajax.call([\n                {methodname: 'tool_messenger_predict_users', args: params}\n            ])[0].done(function (response) {\n                $('#predictionbox').text(response);\n            }).fail(function (ex) {\n                window.console.log('fetch predicted users failed: ');\n                window.console.log(ex);\n            });\n        });\n    };\n\n    /**\n     * This function removes all hidden followup and abort fields and attaches a listener to the abort\n     * and followup buttons that will add them as followup:id or abort:id in the form on click.\n     * This is done to enable the use of the abort and followup button while using mform->data which would be sanitized\n     * otherwise. It also ensures that \"abort\" or \"followup\" will not be saved across instances of this form as to stop\n     * accidental resending of this formdata.\n     */\n    var sanitize_form = function () {\n        $('input[name=abort][type=hidden]').each(function (i, x) {\n            x.remove();\n        });\n        $('input[name=followup][type=hidden]').each(function (i, x) {\n            x.remove();\n        });\n        $('td > input').each(function (i, input) {\n            var button = $(input);\n            var [name, value] = input[\"id\"].split('_');\n            button.on('click', append($('form.mform')[0].id, name, value));\n            return true;\n        });\n    };\n\n    var init = function() {\n        $(document).ready(function() {\n            sanitize_form();\n            initialize_showmessage_buttons();\n            init_predicitonlink();\n        });\n    };\n\n    return {\n        init: init\n    };\n});"],"file":"options.min.js"}